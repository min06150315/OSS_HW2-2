<!-- 
    오픈소스 스튜디오 Assignment#4-1 Ajax 구현 
    json-server --watch data.json --port 3001
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        #contents {
            background-color: #FAFAD6;
            width: 40%;
        }
    </style>
</head>
<body>
    <button id="btnStu">학생 데이터 가져오기</button><br>
    <input type="text" id="name" placeholder="name">
    <input type="number" id="age" placeholder="age">
    <button id="btnAdd">학생 데이터 추가</button><br>
    <div id="contents"></div>  
</body>
</html>

<script>
    window.onload = function() {
        let btnStu = document.getElementById("btnStu");
        let btnAdd = document.getElementById("btnAdd");
        btnStu.addEventListener("click", getStudents);
        btnAdd.addEventListener("click", postData);
    }
    
    // 학생 정보 가져와서 리스트로 출력하기
    function getStudents() {
        let contents = document.getElementById("contents");
        const xhr = new XMLHttpRequest();

        xhr.open("GET", "http://localhost:3001/students");
        xhr.setRequestHeader("content-type", "application/json");
        xhr.send();

        xhr.onload = () => {
            if (xhr.status === 200) {
                const res = JSON.parse(xhr.response);
                contents.innerHTML = makeList(res);
            } else {
                console.log(xhr.status, xhr.statusText);
            }
        }
    }

    // 학생 리스트 만들기
    function makeList(data) {
        let str = "<ul>";
        for (let key in data) {
            str += `<li>${data[key].name} (${data[key].age}) 
                    <button onclick="updateData(${data[key].id})">Update</button> 
                    <button onclick="deleteData(${data[key].id})">Delete</button></li>`;
        }
        str += "</ul>";
        return str;
    }

    // 학생 정보 서버로 보내기
    function postData() {
        let contents = document.getElementById("contents");
        let name = document.getElementById("name");
        let age = document.getElementById("age");

        // 기존 학생 리스트에서 마지막 학생의 ID를 가져와 +1
        const xhr = new XMLHttpRequest();
        xhr.open("GET", "http://localhost:3001/students");
        xhr.send();
        xhr.onload = () => {
            if (xhr.status === 200) {
                const students = JSON.parse(xhr.response);
                let newId = students.length > 0 ? students[students.length - 1].id + 1 : 1;

                // 새 학생 데이터 추가
                const newStudent = { id: newId, name: name.value, age: parseInt(age.value) };

                const postXhr = new XMLHttpRequest();
                postXhr.open("POST", "http://localhost:3001/students");
                postXhr.setRequestHeader("content-type", "application/json; charset=UTF-8");
                postXhr.send(JSON.stringify(newStudent));

                postXhr.onload = () => {
                    if (postXhr.status === 201) {
                        name.value = "";
                        age.value = "";
                        getStudents();
                    } else {
                        console.log(postXhr.status, postXhr.statusText);
                    }
                }
            }
        };
    }


    // 학생 정보 수정하기
    function updateData(id) {
        let name = prompt("수정할 이름을 입력하세요:");
        let age = prompt("수정할 나이를 입력하세요:");
        if (name && age) {
            const xhr = new XMLHttpRequest();
            xhr.open("PUT", `http://localhost:3001/students/${id}`);
            xhr.setRequestHeader("content-type", "application/json; charset=UTF-8");
            const data = { name: name, age: parseInt(age) };

            xhr.send(JSON.stringify(data));

            xhr.onload = () => {
                if (xhr.status === 200) {
                    getStudents();
                } else {
                    console.log(xhr.status, xhr.statusText);
                }
            }
        }
    }

    // 학생 정보 삭제하기
    function deleteData(id) {
        const xhr = new XMLHttpRequest();
        xhr.open("DELETE", `http://localhost:3001/students/${id}`);
        xhr.send();

        xhr.onload = () => {
            if (xhr.status === 200) {
                getStudents();
            } else {
                console.log(xhr.status, xhr.statusText);
            }
        }
    }
</script>
